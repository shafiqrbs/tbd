<?php

namespace Modules\Inventory\App\Repositories;
use Modules\Inventory\App\Entities\Config;
use Modules\Inventory\App\Entities\BusinessDamage;
use Modules\Inventory\App\Entities\BusinessInvoiceAccessories;
use Modules\Inventory\App\Entities\BusinessInvoiceReturn;
use Modules\Inventory\App\Entities\BusinessInvoiceReturnItem;
use Modules\Inventory\App\Entities\BusinessProduction;
use Modules\Inventory\App\Entities\BusinessProductionElement;
use Modules\Inventory\App\Entities\BusinessProductionExpense;
use Modules\Inventory\App\Entities\BusinessPurchase;
use Modules\Inventory\App\Entities\BusinessPurchaseItem;
use Modules\Inventory\App\Entities\BusinessInvoice;
use Modules\Inventory\App\Entities\BusinessInvoiceParticular;

use Modules\Inventory\App\Entities\Product;
use Modules\Inventory\App\Entities\BusinessPurchaseReturn;
use Modules\Inventory\App\Entities\BusinessPurchaseReturnItem;
use Modules\Inventory\App\Entities\BusinessStockHistory;
use Modules\Inventory\App\Entities\ProductTransfer;
use Appstore\Bundle\RestaurantBundle\Entity\ProductionElement;
use Modules\Core\App\Entities\User;
use Doctrine\ORM\EntityRepository;
use Gregwar\Image\Image;
use Modules\Domain\App\Entities\GlobalOption;


/**
 * BusinessParticularRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BusinessStockHistoryRepository extends EntityRepository
{


    public function getWearHouseStocks($pagination){

        $arrs = array();
        foreach ($pagination as $row){
            $arrs[] = $row->getId();
        }
        $qb = $this->createQueryBuilder('e');
        $qb->join('e.item','i');
        $qb->join('e.wearHouse','wh');
        $qb->select('(COALESCE(SUM(e.quantity),0) AS quantity');
        $qb->addSelect('i.id as itemId','i.name');
        $qb->addSelect('wh.id as wearHouseId','wh.name as wearHouse');
        $qb->where('i.id IN (:config)')->setParameter('config', $arrs) ;
        $qb->orderBy('i.name','ASC');
        $qb->groupBy('wh.id','i.id');
        $result = $qb->getQuery()->getArrayResult();
        $array = array();
        foreach ($result as $row){
            $group = "{$row['itemId']}-{$row['wearHouseId']}";
            $array[$group] = $row;

        }
        return $array;

    }

    public function getItemOpeningQuantity(Product $item){
        $em = $this->_em;
        $qb = $this->createQueryBuilder('e');
        $qb->select('(COALESCE(SUM(e.quantity),0) AS openingQuantity');
        $qb->where("e.item = :item")->setParameter('item', $item->getId());
        $result = $qb->getQuery()->getSingleResult();
        $openingQuantity = $result['openingQuantity'];

    }

    public function OpeningInsertQuantity(Product $item){
        $em = $this->_em;
        $exist = $this->findOneBy(array('process'=>'opening','businessConfig'=>$item->getBusinessConfig(),'item'=>$item));
        if(empty($exist)){
            $entity = new BusinessStockHistory();
            $entity->setQuantity($item->getOpeningQuantity());
            $entity->setOpening($item->getOpeningQuantity());
            $entity->setItem($item);
            $entity->setBusinessConfig($item->getBusinessConfig());
            $entity->setProcess('opening');
            $entity->setClosingQuantity(floatval($item->getOpeningQuantity()));
            $em->persist($entity);
            $em->flush();
        }else{
            $entity = $exist;
            $entity->setQuantity($item->getOpeningQuantity());
            $entity->setOpening($item->getOpeningQuantity());
            $entity->setItem($item);
            $entity->setBusinessConfig($item->getBusinessConfig());
            $entity->setProcess('opening');
            $entity->setClosingQuantity(floatval($item->getOpeningQuantity()));
            $em->persist($entity);
            $em->flush();
        }


    }

    public function updateItemClosingQuantity(BusinessStockHistory $stock){
        $em = $this->_em;
        $closingQnt = ($stock->getOpeningQuantity() + $stock->getQuantity());
        $stock->setClosingQuantity($closingQnt);
        $em->persist($stock);
        $em->flush();

    }

    public function processStockQuantity($item , $fieldName = ''){

        $em = $this->_em;
        $openingQnt = 0;
        $openingQnt = $this->getItemOpeningQuantity($item->getBusinessParticular());

        /* @var  $entity BusinessStockHistory */

        $entity = new BusinessStockHistory();

        if($fieldName == 'purchase'){

            /* @var $item BusinessPurchaseItem */

            $exist = $this->findOneBy(array('purchaseItem' => $item));
            if($exist){ $entity = $exist; }
            $entity->setQuantity($item->getQuantity());
            $entity->setPurchaseQuantity($item->getQuantity());
            $entity->setItem($item->getBusinessParticular());
            if($item->getWearhouse()){
                $entity->setWearHouse($item->getWearhouse());
            }
            $entity->setPurchaseItem($item);
            $entity->setProcess('purchase');


        }elseif($fieldName == 'purchase-return') {

            /* @var $item BusinessPurchaseReturnItem */

            $entity->setQuantity("-{$item->getQuantity()}");
            $entity->setPurchaseReturnQuantity($item->getQuantity());
            $entity->setItem($item->getBusinessParticular());
            if($item->getWearhouse()){
                $entity->setWearHouse($item->getWearhouse());
            }
            $entity->setPurchaseReturnItem($item);
            $entity->setProcess('purchase-return');

        }elseif($fieldName == 'sales'){

            /* @var $item BusinessInvoiceParticular */

            $quantity = ($item->getTotalQuantity() + $item->getBonusQnt());
            $entity->setQuantity("-{$quantity}");
            $entity->setSalesQuantity($quantity);
            $entity->setBonusSalesQuantity($item->getBonusQnt());
            if($item->getWearhouse()){
                $entity->setWearHouse($item->getWearhouse());
            }
            if($item->getBusinessInvoice()->getMarketing()) {
                $entity->setMarketing($item->getBusinessInvoice()->getMarketing());
            }
            $entity->setSalesPrice($item->getPrice());
            $entity->setItem($item->getBusinessParticular());
            $entity->setSalesItem($item);
            $entity->setProcess('sales');

        }elseif($fieldName == 'sales-return'){

            /* @var $item BusinessInvoiceReturnItem */

            $entity->setQuantity($item->getQuantity());
            $entity->setSalesQuantity("-{$item->getQuantity()}");
            $entity->setItem($item->getParticular());
            $entity->setSalesReturnItem($item);
            if($item->getWearhouse()){
                $entity->setWearHouse($item->getWearhouse());
            }
           /* if($item->getInvoiceParticular()->getBusinessInvoice()->getMarketing()) {
                $entity->setMarketing($item->getInvoiceParticular()->getBusinessInvoice()->getMarketing());
            }*/
            $entity->setSalesPrice($item->getPrice());
            $entity->setProcess('sales-return');

        }elseif($fieldName == 'damage') {

            /* @var $item BusinessDamage */

            $entity->setQuantity("-{$item->getQuantity()}");
            $entity->setDamageQuantity($item->getQuantity());
            $entity->setItem($item->getBusinessParticular());
            $entity->setDamageItem($item);
            $entity->setProcess('sales-return');

        }elseif($fieldName == 'from-transfer') {

            /* @var $item ProductTransfer */

            $entity->setQuantity("-{$item->getQuantity()}");
            $entity->setTransferQuantity("-{$item->getQuantity()}");
            $entity->setItemTransfer($item);
            $entity->setItem($item->getBusinessParticular());
            $entity->setWearHouse($item->getFromWearHouse());
            $entity->setProcess('from-transfer');

        }elseif($fieldName == 'to-transfer') {

            /* @var $item ProductTransfer */
            $entity->setQuantity("{$item->getQuantity()}");
            $entity->setTransferQuantity($item->getQuantity());
            $entity->setItemTransfer($item);
            $entity->setItem($item->getBusinessParticular());
            $entity->setWearHouse($item->getToWearHouse());
            $entity->setProcess('to-transfer');

        }
        if($openingQnt){
            $entity->setOpeningQuantity(floatval($openingQnt));
        }else{
            $entity->setOpeningQuantity(0);
        }
        $closingQuantity = $entity->getQuantity() + $entity->getOpeningQuantity();
        $entity->setClosingQuantity(floatval($closingQuantity));
        $entity->setBusinessConfig($item->getBusinessParticular()->getBusinessConfig());
        $em->persist($entity);
        $em->flush();

    }

    public function stockTransfer(ProductTransfer $entity){

        $em = $this->_em;
        $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.itemTransfer = '{$entity->getId()}'")->execute();
        $this->processStockQuantity($entity,"from-transfer");
        $this->processStockQuantity($entity,"to-transfer");
    }

    public function processInsertPurchaseItem(BusinessPurchase $entity){

        $em = $this->_em;

        /** @var $item BusinessPurchaseItem  */

        if($entity->getPurchaseItems()){

            foreach($entity->getPurchaseItems() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.purchaseItem = '{$item->getId()}'")->execute();
                $this->processStockQuantity($item,"purchase");
            }
        }
    }

    public function processReversePurchaseItem(BusinessPurchase $entity){

        $em = $this->_em;

        /** @var $item BusinessPurchaseItem  */

        if($entity->getPurchaseItems()){

            foreach($entity->getPurchaseItems() as $item ){
                if($item->getBusinessParticular()){
                    $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.purchaseItem = '{$item->getId()}'")->execute();
                }
            }
        }
    }


    public function processInsertPurchaseReturnItem(BusinessPurchaseReturn $entity){

        $em = $this->_em;

        /** @var $item BusinessPurchaseReturnItem  */

        if($entity->getBusinessPurchaseReturnItems()){

            foreach($entity->getBusinessPurchaseReturnItems() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.purchaseReturnItem = '{$item->getId()}'")->execute();
                if($item->getQuantity() > 0){
                    $this->processStockQuantity($item,"purchase-return");
                }
            }
        }
    }

    public function processInsertSalesItem(BusinessInvoice $entity){

        $em = $this->_em;

        /** @var $item BusinessInvoiceParticular  */

        if($entity->getBusinessInvoiceParticulars()){

            foreach($entity->getBusinessInvoiceParticulars() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.salesItem = '{$item->getId()}'")->execute();
                if($item->getBusinessParticular() and $item->getTotalQuantity() > 0){
                    $this->processStockQuantity($item,"sales");
                }
            }
        }
    }

    public function processReverseSalesItem(BusinessInvoice $entity){

        $em = $this->_em;

        /** @var $item BusinessInvoiceParticular  */

        if($entity->getBusinessInvoiceParticulars()){
            foreach($entity->getBusinessInvoiceParticulars() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.salesItem = '{$item->getId()}'")->execute();
            }
        }
    }

    public function processInsertSalesReturnItem(BusinessInvoiceReturn $entity){

        $em = $this->_em;

        /** @var $item BusinessInvoiceReturnItem  */

        if($entity->getInvoiceReturnItems()){
            foreach($entity->getInvoiceReturnItems() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.salesReturnItem = '{$item->getId()}'")->execute();
                if($item->getQuantity() > 0){
                    $this->processStockQuantity($item,"sales-return");
                }
            }
        }
    }

    public function processInsertDamageItem(BusinessInvoice $entity){

        $em = $this->_em;

        /** @var $item BusinessDamage  */

        if($entity->getBusinessInvoiceParticulars()){

            foreach($entity->getBusinessInvoiceParticulars() as $item ){
                $em->createQuery("DELETE BusinessBundle:BusinessStockHistory e WHERE e.damage = '{$item->getId()}'")->execute();
                if($item->getQuantity() > 0){
                    $this->processStockQuantity($item,"damage");
                }
            }
        }
    }

    public function openingDailyQuantity(Config $config, $data)
    {

        $item = isset($data['name'])? $data['name'] :'';
        if(isset($data['startDate'])){
            $date = new \DateTime($data['startDate']);
        }else{
            $date = new \DateTime();
        }
        $date->add(\DateInterval::createFromDateString('yesterday'));
        $tillDate = $date->format('Y-m-d 23:59:59');
        $qb = $this->createQueryBuilder('e');
        $qb->select('SUM(e.quantity) as openingQnt');
        $qb->join("e.item",'i');
        $qb->where("i.id = :name")->setParameter('name',$item);
        $qb->andWhere("e.created <= :created")->setParameter('created', $tillDate);
        $lastCode = $qb->getQuery()->getOneOrNullResult()['openingQnt'];
        return $lastCode;

    }

    public function monthlyStockLedger(Config $config , $data)
    {
        $config = $config->getId();
        $compare = new \DateTime();
        $month =  $compare->format('F');
        $year =  $compare->format('Y');
        $month = isset($data['month'])? $data['month'] :$month;
        $year = isset($data['year'])? $data['year'] :$year;
        $item = isset($data['name'])? $data['name'] :'';
        $sql = "SELECT DATE_FORMAT(e.created,'%d-%m-%Y') as date ,COALESCE(SUM(e.purchaseQuantity),0) as purchaseQuantity,COALESCE(SUM(e.purchaseReturnQuantity),0) as purchaseReturnQuantity,COALESCE(SUM(e.salesQuantity),0) as salesQuantity,COALESCE(SUM(e.salesReturnQuantity),0) as salesReturnQuantity,COALESCE(SUM(e.damageQuantity),0) as damageQuantity,COALESCE(SUM(e.bonusSalesQuantity),0) as bonusSalesQuantity
                FROM business_stock_history as e
                JOIN business_particular ON e.item_id = business_particular.id
                WHERE e.businessConfig_id = :config AND business_particular.id = :item  AND MONTHNAME(e.created) =:month AND YEAR(e.created) =:year
                GROUP BY date";
        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->bindValue('config', $config);
        $stmt->bindValue('item', "{$item}");
        $stmt->bindValue('month', $month);
        $stmt->bindValue('year', $year);
        $stmt->execute();
        $results =  $stmt->fetchAll();
        $arrays = [];
        foreach ($results as $result){
            $arrays[$result['date']] = $result;
        }
        return $arrays;
    }

    public function getStockHistoryLedger($config,$data)
    {
        $config = $config->getId();
        $compare = new \DateTime();
        $date = $compare->format('Y-m-d');
        $startDa = isset($data['startDate']) ? $data['startDate'] : $date;
        $start = new \DateTime($startDa);
        $startDate = $start->format('Y-m-d');
        $endDa = isset($data['endDate']) ? $data['endDate'] : $date;
        $end = new \DateTime($endDa);
        $endDate = $end->format('Y-m-d');
        $item = isset($data['particular']) ? $data['particular'] : '';
        $process = isset($data['process']) ? $data['process'] : '';
        if(empty($process)){
            $sql = "SELECT e.*,i.invoice as salesInvoice,c.name as customer,p.grn as grn,fu.username as createdBy
                FROM business_stock_history as e
                JOIN business_particular ON e.item_id = business_particular.id
                LEFT JOIN fos_user as fu  ON e.createdBy_id = fu.id
                LEFT JOIN business_purchase_item as pi  ON e.purchaseItem_id = pi.id
                LEFT JOIN business_purchase as p  ON pi.businessPurchase_id = p.id
                LEFT JOIN business_purchase_return_item as pri  ON e.purchaseReturnItem_id = pri.id
                LEFT JOIN business_purchase_return as bpr  ON pri.businessPurchaseReturn_id = bpr.id
                LEFT JOIN business_invoice_particular as ip  ON e.salesItem_id = ip.id
                LEFT JOIN business_invoice as i  ON ip.businessInvoice_id = i.id
                LEFT JOIN Customer as c  ON i.customer_id = c.id
                LEFT JOIN business_invoice_return_item as sri  ON e.salesReturnItem_id  = sri.id
                LEFT JOIN business_invoice_return as bir  ON sri.invoiceReturn_id = bir.id
                LEFT JOIN business_damage as d  ON e.damageItem_id  = d.id
                WHERE e.businessConfig_id = :config AND business_particular.id = :item  AND e.created BETWEEN '{$startDate}' AND '{$endDate}'
                ORDER BY e.created ASC";
            $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
            $stmt->bindValue('config', $config);
            $stmt->bindValue('item', "{$item}");
            $stmt->execute();
            $results = $stmt->fetchAll();
            return $results;
        }else{
            $sql = "SELECT e.*,i.invoice as salesInvoice,c.name as customer,p.grn as grn,fu.username as createdBy
                FROM business_stock_history as e
                JOIN business_particular ON e.item_id = business_particular.id
                LEFT JOIN fos_user as fu  ON e.createdBy_id = fu.id
                LEFT JOIN business_purchase_item as pi  ON e.purchaseItem_id = pi.id
                LEFT JOIN business_purchase as p  ON pi.businessPurchase_id = p.id
                LEFT JOIN business_purchase_return_item as pri  ON e.purchaseReturnItem_id = pri.id
                LEFT JOIN business_purchase_return as bpr  ON pri.businessPurchaseReturn_id = bpr.id
                LEFT JOIN business_invoice_particular as ip  ON e.salesItem_id = ip.id
                LEFT JOIN business_invoice as i  ON ip.businessInvoice_id = i.id
                LEFT JOIN Customer as c  ON i.customer_id = c.id
                LEFT JOIN business_invoice_return_item as sri  ON e.salesReturnItem_id  = sri.id
                LEFT JOIN business_invoice_return as bir  ON sri.invoiceReturn_id = bir.id
                LEFT JOIN business_damage as d  ON e.damageItem_id  = d.id
                WHERE e.businessConfig_id = :config AND business_particular.id = :item  AND e.created BETWEEN '{$startDate}' AND '{$endDate}'
                AND e.process='{$process}' ORDER BY e.created ASC ";
            $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
            $stmt->bindValue('config', $config);
            $stmt->bindValue('item', "{$item}");
            $stmt->execute();
            $results = $stmt->fetchAll();
            return $results;
        }


    }


}
